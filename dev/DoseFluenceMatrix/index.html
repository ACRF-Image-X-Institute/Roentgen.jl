<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Dose-Fluence Matrix · Roentgen.jl Documentation</title><meta name="title" content="Dose-Fluence Matrix · Roentgen.jl Documentation"/><meta property="og:title" content="Dose-Fluence Matrix · Roentgen.jl Documentation"/><meta property="twitter:title" content="Dose-Fluence Matrix · Roentgen.jl Documentation"/><meta name="description" content="Documentation for Roentgen.jl Documentation."/><meta property="og:description" content="Documentation for Roentgen.jl Documentation."/><meta property="twitter:description" content="Documentation for Roentgen.jl Documentation."/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">Roentgen.jl Documentation</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Roentgen.jl</a></li><li><span class="tocitem">Dose Volume</span><ul><li><a class="tocitem" href="../DoseVolume/">Dose Volumes</a></li><li><a class="tocitem" href="../DosePositions/">Dose Positions</a></li><li><a class="tocitem" href="../ExternalSurfaces/">External Surfaces</a></li></ul></li><li><span class="tocitem">Computing Dose</span><ul><li><a class="tocitem" href="../DoseReconstruction/">Dose Reconstruction from a Treatment Plan</a></li><li><a class="tocitem" href="../Fluence/">Generating Fluence Maps</a></li><li class="is-active"><a class="tocitem" href>Dose-Fluence Matrix</a><ul class="internal"><li><a class="tocitem" href="#Beamlets"><span>Beamlets</span></a></li><li><a class="tocitem" href="#Creating-Dose-Fluence-Matrices"><span>Creating Dose-Fluence Matrices</span></a></li></ul></li><li><a class="tocitem" href="../DoseCalculationAlgorithms/">Dose Calculation Algorithms</a></li></ul></li><li><span class="tocitem">Utilties</span><ul><li><a class="tocitem" href="../Structures/">Structures</a></li><li><a class="tocitem" href="../TreatmentPlan/">Treatment Plan</a></li></ul></li><li><a class="tocitem" href="../API/">API</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Computing Dose</a></li><li class="is-active"><a href>Dose-Fluence Matrix</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Dose-Fluence Matrix</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/Image-X-Institute/Roentgen.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/Image-X-Institute/Roentgen.jl/blob/main/docs/src/DoseFluenceMatrix.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Dose-Fluence-Matrix"><a class="docs-heading-anchor" href="#Dose-Fluence-Matrix">Dose-Fluence Matrix</a><a id="Dose-Fluence-Matrix-1"></a><a class="docs-heading-anchor-permalink" href="#Dose-Fluence-Matrix" title="Permalink"></a></h1><p>Dose-fluence matrices are precomputed doses for each beamlet used in the treatment. In dose calculations, it is typical for a broad radiation beam to be split up into a number of beamlets. These beamlets can then be &quot;turned on/off&quot; depending on whether that beamlet is obscured by a beam-limiting device.</p><p>Hence, dose computed through use of a dose-fluence matrix requires four steps:</p><ol><li>Select the beamlets that are to be used in the treatment</li><li>Compute the dose at <code>n</code> dose positions for <code>m</code> beamlets, and store it in a <code>nxm</code> matrix, <span>$D$</span>.</li><li>Compute the fluence and meterset increment for each beamlet, and store in an <code>m</code> length vector, <span>$w$</span>.</li><li>Compute the final dose by multiplying the dose-fluence matrix <span>$D$</span> by <span>$w$</span>: <span>$\mathrm{dose}=Dw$</span></li></ol><p>An example can be found in the <a href="https://github.com/Image-X-Institute/Roentgen.jl/blob/main/examples/Dose%20from%20Aperture.ipynb">Dose From Aperture</a> notebook.</p><h2 id="Beamlets"><a class="docs-heading-anchor" href="#Beamlets">Beamlets</a><a id="Beamlets-1"></a><a class="docs-heading-anchor-permalink" href="#Beamlets" title="Permalink"></a></h2><p>Beamlets have three features:</p><ul><li>An origin, typically where the radiation originates</li><li>A direction, pointing away from the source</li><li>Widths in directions perpendicular to the beamlet direct, usually scaled to the isoplane</li></ul><p>Beamlets can be be constructed by combining a <code>Bixel</code> and <code>GantryPosition</code>,</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; bixel = Bixel(0., 0., 1., 1.)</code><code class="nohighlight hljs ansi" style="display:block;">Bixel{Float64}([0.0, 0.0], [1.0, 1.0])</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; gantry = GantryPosition(0., 0., 1000.)</code><code class="nohighlight hljs ansi" style="display:block;">ϕg=0.0°, θb=0.0°, SAD=1000.0</code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; beamlet = Beamlet(bixel, gantry)</code><code class="nohighlight hljs ansi" style="display:block;">Beamlet{Float64}([0.5, 0.5], [1.0, -0.0, 0.0], [0.0, -1.0, -0.0], [0.0, 0.0, -1.0], [0.0, 0.0, 1.0], 1000.0, 0.0)</code></pre><p>This will create a square beamlet of width 1 mm, origin of <code>[0., 0., 1000.]</code>, and direction <code>[0., 0., -1.]</code>.</p><p>Collection of beamlets are created using Julia&#39;s broadcast mechanism,</p><pre><code class="language-julia-repl hljs" style="display:block;">julia&gt; bixels = BixelGrid(-5.:5.:5., -5.:5.:5.);</code><code class="nohighlight hljs ansi" style="display:block;"></code><br/><code class="language-julia-repl hljs" style="display:block;">julia&gt; beamlets = Beamlet.(bixels, (gantry,))</code><code class="nohighlight hljs ansi" style="display:block;">2×2 Matrix{Beamlet{Float64}}:
 Beamlet{Float64}([2.5, 2.5], [0.999997, 0.0, -0.00249999], [6.24994e-6, -0.999997, 0.00249998], [-0.00249998, -0.00249998, -0.999994], [0.0, 0.0, 1.0], 1000.0, 0.00353553)  …  Beamlet{Float64}([2.5, 2.5], [0.999997, 0.0, -0.00249999], [-6.24994e-6, -0.999997, -0.00249998], [-0.00249998, 0.00249998, -0.999994], [0.0, 0.0, 1.0], 1000.0, 0.00353553)
 Beamlet{Float64}([2.5, 2.5], [0.999997, -0.0, 0.00249999], [-6.24994e-6, -0.999997, 0.00249998], [0.00249998, -0.00249998, -0.999994], [0.0, 0.0, 1.0], 1000.0, 0.00353553)     Beamlet{Float64}([2.5, 2.5], [0.999997, -0.0, 0.00249999], [6.24994e-6, -0.999997, -0.00249998], [0.00249998, 0.00249998, -0.999994], [0.0, 0.0, 1.0], 1000.0, 0.00353553)</code></pre><h2 id="Creating-Dose-Fluence-Matrices"><a class="docs-heading-anchor" href="#Creating-Dose-Fluence-Matrices">Creating Dose-Fluence Matrices</a><a id="Creating-Dose-Fluence-Matrices-1"></a><a class="docs-heading-anchor-permalink" href="#Creating-Dose-Fluence-Matrices" title="Permalink"></a></h2><p>Dose-fluence matrices are computed using the <a href="../API/#Roentgen.dose_fluence_matrix-Tuple{Any, Roentgen.AbstractDoseVolume, Any, Any}"><code>dose_fluence_matrix</code></a> and <a href="../API/#Roentgen.dose_fluence_matrix!"><code>dose_fluence_matrix!</code></a> functions. These take a [dose volume}(@ref DoseVolumes), vector of beamlets (<a href="#Beamlets">Beamlets</a>) and <a href="../DoseCalculationAlgorithms/#DoseAlgorithms">dose calculation algorithm</a> and compute the corresponding dose for each position in the volume,</p><pre><code class="language-julia hljs">dose_fluence_matrix(T, vol, beamlets, calc; maxradius=100)</code></pre><p>By default, dose is not calculated for every element in the dose-fluence matrix. Dose points that are further away than <code>maxradius</code> (scaled to the isoplane) from the beamlet axis are not computed and assumed to be zero. This speeds up computation (and memory if sparse matrices are used). <code>maxradius</code> is set to 100 mm by default.</p><p><a href="../API/#Roentgen.dose_fluence_matrix-Tuple{Any, Roentgen.AbstractDoseVolume, Any, Any}"><code>dose_fluence_matrix</code></a> creates allocates a new matrix, then computes the matrix values. The first argument requires the matrix type:</p><table><tr><th style="text-align: left">Type</th><th style="text-align: right">Sparse</th><th style="text-align: right">GPU</th></tr><tr><td style="text-align: left"><code>Matrix</code></td><td style="text-align: right">✖</td><td style="text-align: right">✖</td></tr><tr><td style="text-align: left"><code>SparseMatrixCSC</code></td><td style="text-align: right">✔</td><td style="text-align: right">✖</td></tr><tr><td style="text-align: left"><code>CuArray</code></td><td style="text-align: right">✖</td><td style="text-align: right">✔</td></tr></table><p>Each choice has benefits and downsides. Using a dense <code>Matrix</code> might be the fastest and easiest to manage memory wise, but comes with potentially large memory requirements depending on the number of positions or beamlets. A sparse <code>SparseMatrixCSC</code> only stores non-zero elements of the matrix, and is therefore less memory intensive and may be faster depending on the size of and number of non-zeros in the matrix.</p><div class="admonition is-warning"><header class="admonition-header">Warning</header><div class="admonition-body"><p>GPU support is still experimental</p></div></div><p>If a GPU is available, using <code>CuArray</code> will move the computation to the GPU and speed up the computation significantly. However, all input arguments must be moved to GPU memory, and some types of external surface are not supported on the GPU. See the <a href="https://github.com/Image-X-Institute/Roentgen.jl/blob/main/examples/Computing%20on%20the%20GPU.ipynb">Computing on the GPU</a> example for details.</p><h3 id="Performance-Intensive-Usage"><a class="docs-heading-anchor" href="#Performance-Intensive-Usage">Performance Intensive Usage</a><a id="Performance-Intensive-Usage-1"></a><a class="docs-heading-anchor-permalink" href="#Performance-Intensive-Usage" title="Permalink"></a></h3><p><a href="../API/#Roentgen.dose_fluence_matrix!"><code>dose_fluence_matrix!</code></a> should be used for more perfomance intensive applications, modifying the supplied matrix. In this case, the method will specialise depending on the type of the matrix,</p><pre><code class="language-julia hljs">dose_fluence_matrix!(D, vol, beamlets, calc; maxradius=100)</code></pre><p>where <code>D</code> is the matrix.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../Fluence/">« Generating Fluence Maps</a><a class="docs-footer-nextpage" href="../DoseCalculationAlgorithms/">Dose Calculation Algorithms »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="auto">Automatic (OS)</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.1.1 on <span class="colophon-date" title="Thursday 19 October 2023 02:18">Thursday 19 October 2023</span>. Using Julia version 1.9.3.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
